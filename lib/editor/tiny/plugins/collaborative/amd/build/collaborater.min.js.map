{"version":3,"file":"collaborater.min.js","sources":["../src/collaborater.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Storage helper for the Moodle Tiny Autosave plugin.\n *\n * @module      tiny_autosave/autosaver\n * @copyright   2022 Andrew Lyons <andrew@nicols.co.uk>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n//import * as Options from './options';\n//import * as Storage from './storage';mm\n//import Log from 'core/log';\n//import {eventTypes} from 'core_form/events';\n//import {getLogSource} from './common';\nimport * as jsDiff from './jsdiff/index';\nimport {call} from 'core/ajax';\nimport * as Options from \"./options\";\n\n\nlet currentContent = '';\nlet currentHash = '';\nlet newHash = '';\n//let newContent = '';\n//let lastHash = '';\nconst INTERVALTIMEOUT = 1000;\nconst HEADER = \"Index: a\\n===================================================================\\n\";\n\nconst fetchOne = (methodname, args) => call([{\n    methodname,\n    args,\n}])[0];\nlet intervalId = null;\n\nasync function sha1(message) {\n    const encoder = new TextEncoder();\n    const data = encoder.encode(message);\n    const hashBuffer = await crypto.subtle.digest('SHA-1', data);\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\n    const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');\n    return hashHex;\n}\n\n// Example usage:\nconst insertCursorMarker = (editor) => {\n    const markerId = 'cursor-marker-' + new Date().getTime();\n    editor.selection.collapse();\n    editor.selection.setContent(`<span id=\"${markerId}\"></span>`);\n    return markerId;\n};\nconst restoreCursorPositionFromMarker = (editor, markerId) => {\n    const markerElement = editor.getBody().querySelector(`#${markerId}`);\n    if (markerElement) {\n        const range = editor.dom.createRng();\n        range.setStartAfter(markerElement);\n        range.collapse(true);\n        editor.selection.setRng(range);\n        editor.dom.remove(markerElement); // Clean up marker\n       // editor.focus();\n    } else {\n        // Fallback if marker not found\n       // editor.focus();\n        editor.selection.select(editor.getBody(), true);\n        editor.selection.collapse(false);\n    }\n};\n\n\nexport const register = (editor) => {\n        // Attempt to store the draft one final time before the page unloads.\n    // Note: This may need to be sent as a beacon instead.\n   // document.addEventListener('visibilitychange', visibilityChangedHandler);\n\n    // When the page is submitted as a form, remove the draft.\n   // editor.on('submit', removeAutoSaveSession);\n   // document.addEventListener(eventTypes.formSubmittedByJavascript, handleFormSubmittedByJavascript);\n    const c = window.console;\n    editor.on('init', () => {\n        let status_bar_element = document.createElement(\"p\");\n        const txt = document.createTextNode(\"Collaboratiny initialized.\");\n        status_bar_element.appendChild(txt);\n\n        editor\n            .getElement()\n            .nextElementSibling\n            .getElementsByClassName(\"tox-statusbar__right-container\")[0]\n            .prepend(status_bar_element);\n\n        let x = 0;\n        setInterval(() => {\n            const newContent = editor.getContent();\n            sha1(newContent).then(hash => {\n                newHash = hash;\n                if (currentHash === '') {\n                    currentContent = newContent;\n                    currentHash = newHash;\n                    return;\n                }\n                if (newHash !== currentHash) {\n                    let patch = jsDiff.createPatch('a', currentContent, newContent);\n                    patch = patch.substring(HEADER.length);\n                   /* c.log('contextid', Options.getContextId(editor));\n                    c.log('pagehash', Options.getPageHash(editor));\n                    c.log('pageinstance', Options.getPageInstance(editor));\n                    c.log('elementid', editor.targetElm.id);\n                    c.log('oldcontenthash', currentHash);\n                    c.log('newcontenthash', newHash);\n                    c.log('changes', patch);*/\n                    return fetchOne('tiny_collaborate_save_changes', {\n                        contextid: Options.getContextId(editor),\n                        //pageinstance: Options.getPageInstance(editor),\n                        elementid: editor.targetElm.id,\n                        /*drftid: Options.getDraftItemId(editor),*/\n                        oldcontenthash: currentHash,\n                        newcontenthash: newHash,\n                        changes: patch,\n\n                    })\n                    .then((result) => {\n                       //* pendingPromise.resolve();\n                       // c.log('new hash', newHash);\n                      //  c.log('diff', patch);\n                        currentContent = newContent;\n                        currentHash = newHash;\n                        return result;\n                    });\n                }\n            });\n            if (currentHash === '') {\n                return;\n            }\n\n            let newContent2 = editor.getContent();\n            fetchOne('tiny_collaborate_get_changes', {\n                contextid: Options.getContextId(editor),\n                elementid: editor.targetElm.id,\n                currenthash: currentHash,\n            }).then((result) => {\n                status_bar_element.innerText = \"Counter \" + x++;\n                c.log(status_bar_element);\n                c.log(\"HAAAAALLO\");\n                if (result) {\n                    let changesMade = false;\n                    const changes = result.changes;\n                    for (let change in changes) {\n                        c.log('shorthcange', change);\n                        let patch = HEADER + change;\n                        c.log('changes', patch);\n                        c.log('parsedPatch', jsDiff.parsePatch(patch));\n                        newContent2 = jsDiff.applyPatch(newContent2, patch);\n                        changesMade = true;\n                    }\n                    if (changesMade) {\n                        if (newContent2 === false) {\n                            c.log('Patch FAILED');\n                        } else {\n                            c.log('newContent2', newContent2);\n                            editor.setContent(newContent2);\n                            currentContent = newContent2;\n                            sha1(newContent2).then(hash => {\n                                currentHash = hash;\n                                c.log('new hash', currentHash);\n                            });\n                        }\n                    }\n                    //clearInterval(intervalId);\n                }\n\n             //   restoreCursorPositionFromMarker(editor, markerId);\n            });\n\n        }, INTERVALTIMEOUT);\n\n        /*editor.on('Change', (event) => {\n            c.log('Change collaborative', event);\n        });*/\n        // Setup the Undo handler.\n        //editor.on('AddUndo', undoHandler);\n\n       /* if (editor.dom.isEmpty(editor.getBody())) {\n            Log.info(`Attempting to restore draft`, getLogSource(editor));\n            Storage.restoreDraft(editor);\n        } else {\n            // There was nothing to restore, so we can mark the editor as initialised.\n            Log.warn(`Skipping draft restoration. The editor is not empty.`, getLogSource(editor));\n            Options.markInitialised(editor);\n        }*/\n    });\n};\n"],"names":["currentContent","currentHash","newHash","HEADER","fetchOne","methodname","args","sha1","message","data","TextEncoder","encode","hashBuffer","crypto","subtle","digest","Array","from","Uint8Array","map","byte","toString","padStart","join","editor","c","window","console","on","status_bar_element","document","createElement","txt","createTextNode","appendChild","getElement","nextElementSibling","getElementsByClassName","prepend","x","setInterval","newContent","getContent","then","hash","patch","jsDiff","createPatch","substring","length","contextid","Options","getContextId","elementid","targetElm","id","oldcontenthash","newcontenthash","changes","result","newContent2","currenthash","innerText","log","changesMade","change","parsePatch","applyPatch","setContent"],"mappings":";;;;;;;0KAiCIA,eAAiB,GACjBC,YAAc,GACdC,QAAU,SAIRC,OAAS,kFAETC,SAAW,CAACC,WAAYC,QAAS,cAAK,CAAC,CACzCD,WAAAA,WACAC,KAAAA,QACA,kBAGWC,KAAKC,eAEVC,MADU,IAAIC,aACCC,OAAOH,SACtBI,iBAAmBC,OAAOC,OAAOC,OAAO,QAASN,aACrCO,MAAMC,KAAK,IAAIC,WAAWN,aAClBO,KAAIC,MAAQA,KAAKC,SAAS,IAAIC,SAAS,EAAG,OAAMC,KAAK,sBA6B1DC,eAQfC,EAAIC,OAAOC,QACjBH,OAAOI,GAAG,QAAQ,SACVC,mBAAqBC,SAASC,cAAc,WAC1CC,IAAMF,SAASG,eAAe,8BACpCJ,mBAAmBK,YAAYF,KAE/BR,OACKW,aACAC,mBACAC,uBAAuB,kCAAkC,GACzDC,QAAQT,wBAETU,EAAI,EACRC,aAAY,WACFC,WAAajB,OAAOkB,gBAC1BnC,KAAKkC,YAAYE,MAAKC,UAClB1C,QAAU0C,KACU,KAAhB3C,mBACAD,eAAiByC,gBACjBxC,YAAcC,YAGdA,UAAYD,YAAa,KACrB4C,MAAQC,OAAOC,YAAY,IAAK/C,eAAgByC,mBACpDI,MAAQA,MAAMG,UAAU7C,OAAO8C,QAQxB7C,SAAS,gCAAiC,CAC7C8C,UAAWC,QAAQC,aAAa5B,QAEhC6B,UAAW7B,OAAO8B,UAAUC,GAE5BC,eAAgBvD,YAChBwD,eAAgBvD,QAChBwD,QAASb,QAGZF,MAAMgB,SAIH3D,eAAiByC,WACjBxC,YAAcC,QACPyD,cAIC,KAAhB1D,uBAIA2D,YAAcpC,OAAOkB,aACzBtC,SAAS,+BAAgC,CACrC8C,UAAWC,QAAQC,aAAa5B,QAChC6B,UAAW7B,OAAO8B,UAAUC,GAC5BM,YAAa5D,cACd0C,MAAMgB,YACL9B,mBAAmBiC,UAAY,WAAavB,IAC5Cd,EAAEsC,IAAIlC,oBACNJ,EAAEsC,IAAI,aACFJ,OAAQ,KACJK,aAAc,QACZN,QAAUC,OAAOD,YAClB,IAAIO,UAAUP,QAAS,CACxBjC,EAAEsC,IAAI,cAAeE,YACjBpB,MAAQ1C,OAAS8D,OACrBxC,EAAEsC,IAAI,UAAWlB,OACjBpB,EAAEsC,IAAI,cAAejB,OAAOoB,WAAWrB,QACvCe,YAAcd,OAAOqB,WAAWP,YAAaf,OAC7CmB,aAAc,EAEdA,eACoB,IAAhBJ,YACAnC,EAAEsC,IAAI,iBAENtC,EAAEsC,IAAI,cAAeH,aACrBpC,OAAO4C,WAAWR,aAClB5D,eAAiB4D,YACjBrD,KAAKqD,aAAajB,MAAKC,OACnB3C,YAAc2C,KACdnB,EAAEsC,IAAI,WAAY9D,wBAxI1B"}